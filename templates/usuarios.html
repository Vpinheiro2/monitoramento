{% extends "base.html" %}
{% block title %}Gerenciamento de UsuÃ¡rios{% endblock %}
{% block content %}
<div class="page-header" style="background: white; padding: 2rem; border-radius: 12px; margin-bottom: 2rem;">
    <h1 style="font-size: 2rem; color: var(--primary); margin-bottom: 0.5rem;">ğŸ‘¥ Gerenciamento de UsuÃ¡rios</h1>
    <p style="color: #64748b;">CriaÃ§Ã£o de usuÃ¡rios e controle granular de permissÃµes</p>
    <p><a href="{{ url_for('ti') }}" style="color: var(--primary);">â† Voltar para TI</a></p>
</div>
<div style="margin-bottom: 2rem;"><button onclick="openAddUserModal()" class="btn btn-success">â• Criar Novo UsuÃ¡rio</button></div>
<div class="card">
    <h2 class="card-title">ğŸ‘¤ UsuÃ¡rios Cadastrados</h2>
    <table style="width: 100%; border-collapse: collapse;">
        <thead style="background: var(--primary); color: white;">
            <tr>
                <th style="padding: 1rem; text-align: left;">UsuÃ¡rio</th>
                <th style="padding: 1rem; text-align: left;">Nome</th>
                <th style="padding: 1rem; text-align: left;">E-mail</th>
                <th style="padding: 1rem; text-align: left;">Cargo/FunÃ§Ã£o</th>
                <th style="padding: 1rem; text-align: left;">Grupo</th>
                <th style="padding: 1rem; text-align: left;">Status</th>
                <th style="padding: 1rem; text-align: left;">AÃ§Ãµes</th>
            </tr>
        </thead>
        <tbody>
            {% for username, user in usuarios.items() %}
            <tr style="border-bottom: 1px solid #e2e8f0;">
                <td style="padding: 1rem;"><strong>{{ username }}</strong></td>
                <td style="padding: 1rem;">{{ user.nome }}</td>
                <td style="padding: 1rem;"><small>{{ user.email }}</small></td>
                <td style="padding: 1rem;"><span class="badge badge-info">{{ user.cargo or 'NÃ£o informado' }}</span></td>
                <td style="padding: 1rem;">{% if user.grupo %}<span class="badge badge-secondary">{{ user.grupo }}</span>{% else %}-{% endif %}</td>
                <td style="padding: 1rem;">{% if user.ativo %}<span class="badge badge-success">âœ… Ativo</span>{% else %}<span class="badge badge-secondary">âŒ Inativo</span>{% endif %}</td>
                <td style="padding: 1rem;">
                    <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                        <button onclick='editUser({{ user | tojson }}, "{{ username }}")' class="btn btn-primary" style="padding: 0.5rem 0.75rem;">âœï¸</button>
                        <form method="POST" style="display: inline;"><input type="hidden" name="acao" value="ativar_desativar"><input type="hidden" name="username" value="{{ username }}"><button type="submit" class="btn {% if user.ativo %}btn-secondary{% else %}btn-success{% endif %}" style="padding: 0.5rem 0.75rem;">{% if user.ativo %}ğŸ”’{% else %}ğŸ”“{% endif %}</button></form>
                        <form method="POST" style="display: inline;"><input type="hidden" name="acao" value="resetar_senha"><input type="hidden" name="username" value="{{ username }}"><button type="submit" class="btn btn-warning" style="padding: 0.5rem 0.75rem;" onclick="return confirm('Resetar senha para 123?')">ğŸ”‘</button></form>
                    </div>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
<div id="userModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center; overflow-y: auto;">
    <div style="background: white; padding: 2rem; border-radius: 12px; max-width: 900px; width: 95%; margin: 2rem auto; max-height: 90vh; overflow-y: auto;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
            <h2 id="userModalTitle" style="font-size: 1.5rem; color: var(--primary); margin: 0;">â• Criar UsuÃ¡rio</h2>
            <span onclick="closeUserModal()" style="font-size: 2rem; cursor: pointer; color: #94a3b8;">&times;</span>
        </div>
        <form method="POST" id="userForm">
            <input type="hidden" name="acao" id="userAcao" value="adicionar">
            <div style="background: white; padding: 1.5rem; border-radius: 8px; border-left: 4px solid var(--primary); margin-bottom: 1.5rem;">
                <h3 style="margin-bottom: 1rem;">ğŸ‘¤ Dados do UsuÃ¡rio</h3>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                    <div class="form-group"><label class="form-label">Nome de UsuÃ¡rio *</label><input type="text" name="username" id="userUsername" class="form-control" required></div>
                    <div class="form-group"><label class="form-label">Nome Completo *</label><input type="text" name="nome" id="userNome" class="form-control" required></div>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                    <div class="form-group"><label class="form-label">E-mail *</label><input type="email" name="email" id="userEmail" class="form-control" required></div>
                    <div class="form-group"><label class="form-label">Senha *</label><input type="password" name="senha" id="userSenha" class="form-control"></div>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                    <div class="form-group"><label class="form-label">Cargo/FunÃ§Ã£o</label><input type="text" name="cargo" id="userCargo" class="form-control" placeholder="Ex: Analista, TÃ©cnico, Operador..."></div>
                    <div class="form-group"><label class="form-label">Grupo de Acesso</label><select name="grupo" id="userGrupo" class="form-control"><option value="">Nenhum (usar permissÃµes detalhadas)</option>{% for nome, grupo in grupos.items() %}<option value="{{ nome }}">{{ grupo.nome }}</option>{% endfor %}</select></div>
                </div>
            </div>
            <div style="background: #f8fafc; padding: 1.5rem; border-radius: 8px; border-left: 4px solid var(--warning);">
                <h3 style="margin-bottom: 1rem;">ğŸ” PermissÃµes Detalhadas</h3>
                <p style="color: #64748b; font-size: 0.9rem; margin-bottom: 1rem;">ğŸ’¡ Se um grupo for selecionado, suas permissÃµes serÃ£o combinadas com as permissÃµes detalhadas abaixo.</p>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem;">
                    <div style="background: white; padding: 1rem; border-radius: 8px;">
                        <strong style="color: var(--primary); display: block; margin-bottom: 0.5rem;">ğŸ“Š Dashboard</strong>
                        <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;"><input type="checkbox" name="perm_dashboard">Acessar Dashboard</label>
                    </div>
                    <div style="background: white; padding: 1rem; border-radius: 8px;">
                        <strong style="color: var(--primary); display: block; margin-bottom: 0.5rem;">ğŸ‘¨â€ğŸ”§ Operador</strong>
                        <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;"><input type="checkbox" name="perm_operador">Acessar Painel</label>
                    </div>
                    <div style="background: white; padding: 1rem; border-radius: 8px;">
                        <strong style="color: var(--primary); display: block; margin-bottom: 0.5rem;">ğŸ’» TI</strong>
                        <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;"><input type="checkbox" name="perm_ti">Acessar TI</label>
                    </div>
                    <div style="background: white; padding: 1rem; border-radius: 8px;">
                        <strong style="color: var(--warning); display: block; margin-bottom: 0.5rem;">ğŸ”§ ManutenÃ§Ã£o</strong>
                        <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;"><input type="checkbox" name="perm_manutencao">Acessar Painel</label>
                    </div>
                    <div style="background: white; padding: 1rem; border-radius: 8px;">
                        <strong style="color: var(--info); display: block; margin-bottom: 0.5rem;">ğŸ§¼ HigienizaÃ§Ã£o</strong>
                        <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;"><input type="checkbox" name="perm_higienizacao">Acessar Painel</label>
                    </div>
                    <div style="background: white; padding: 1rem; border-radius: 8px;">
                        <strong style="color: var(--success); display: block; margin-bottom: 0.5rem;">ğŸ”¬ Qualidade</strong>
                        <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;"><input type="checkbox" name="perm_qualidade">Acessar Painel</label>
                    </div>
                    <div style="background: white; padding: 1rem; border-radius: 8px;">
                        <strong style="color: var(--secondary); display: block; margin-bottom: 0.5rem;">ğŸ“Š RelatÃ³rios</strong>
                        <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;"><input type="checkbox" name="perm_relatorios">Acessar RelatÃ³rios</label>
                        {% for id, rel in relatorios_personalizados.items() %}
                        <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; margin-left: 1rem;"><input type="checkbox" name="perm_relatorio_{{ id }}">{{ rel.nome }}</label>
                        {% endfor %}
                    </div>
                </div>
            </div>
            <div style="display: flex; gap: 1rem; justify-content: flex-end; margin-top: 2rem;">
                <button type="button" onclick="closeUserModal()" class="btn btn-secondary">âŒ Cancelar</button>
                <button type="submit" class="btn btn-success" id="userSubmitBtn">âœ… Criar UsuÃ¡rio</button>
            </div>
        </form>
    </div>
</div>
<script>
const usuariosData = {{ usuarios | tojson | safe }};
function openAddUserModal() {
    document.getElementById('userModalTitle').textContent = 'â• Criar Novo UsuÃ¡rio';
    document.getElementById('userAcao').value = 'adicionar';
    document.getElementById('userSubmitBtn').textContent = 'âœ… Criar UsuÃ¡rio';
    document.getElementById('userForm').reset();
    document.getElementById('userUsername').readOnly = false;
    document.getElementById('userSenha').required = true;
    document.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = false);
    document.getElementById('userModal').style.display = 'flex';
}
function editUser(user, username) {
    document.getElementById('userModalTitle').textContent = 'âœï¸ Editar UsuÃ¡rio';
    document.getElementById('userAcao').value = 'editar';
    document.getElementById('userSubmitBtn').textContent = 'ğŸ’¾ Salvar';
    document.getElementById('userUsername').value = username;
    document.getElementById('userUsername').readOnly = true;
    document.getElementById('userNome').value = user.nome;
    document.getElementById('userEmail').value = user.email;
    document.getElementById('userCargo').value = user.cargo || '';
    document.getElementById('userGrupo').value = user.grupo || '';
    document.getElementById('userSenha').value = '';
    document.getElementById('userSenha').required = false;
    document.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = false);
    for (const [perm, value] of Object.entries(user.permissoes)) {
        const checkbox = document.querySelector(`input[name="perm_${perm}"]`);
        if (checkbox) checkbox.checked = value;
    }
    document.getElementById('userModal').style.display = 'flex';
}
function closeUserModal() { document.getElementById('userModal').style.display = 'none'; }
window.onclick = function(event) { if (event.target.id === 'userModal') closeUserModal(); }
</script>
{% endblock %}