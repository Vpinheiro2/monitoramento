{% extends "base.html" %}
{% block title %}Dashboard{% endblock %}
{% block extra_css %}
<style>
.dashboard-header { text-align: center; margin-bottom: 3rem; color: white; }
.dashboard-title { font-size: 3rem; margin-bottom: 0.5rem; text-shadow: 2px 2px 4px rgba(0,0,0,0.2); }
.stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1.5rem; margin-bottom: 3rem; }
.stat-card { background: white; padding: 1.5rem; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); text-align: center; transition: transform 0.3s; }
.stat-card:hover { transform: translateY(-5px); }
.stat-icon { font-size: 3rem; margin-bottom: 0.5rem; }
.stat-value { font-size: 2.5rem; font-weight: bold; margin-bottom: 0.25rem; }
.stat-label { color: #64748b; font-size: 0.9rem; }
.equipamentos-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 2rem; }
.equip-card { background: white; border-radius: 16px; padding: 2rem; box-shadow: 0 4px 12px rgba(0,0,0,0.1); transition: all 0.3s; position: relative; overflow: hidden; }
.equip-card::before { content: ''; position: absolute; top: 0; left: 0; right: 0; height: 6px; }
.equip-card.livre::before { background: var(--success); }
.equip-card.ocupada::before { background: var(--danger); }
.equip-card.manutencao::before { background: var(--warning); }
.equip-card.higienizacao::before { background: var(--info); }
.equip-card:hover { transform: translateY(-5px); box-shadow: 0 12px 24px rgba(0,0,0,0.15); }
.equip-icon { font-size: 4rem; text-align: center; margin-bottom: 1rem; }
.equip-name { font-size: 1.5rem; font-weight: bold; text-align: center; margin-bottom: 1rem; }
.status-badge { display: inline-block; padding: 0.5rem 1rem; border-radius: 20px; font-weight: 600; font-size: 0.9rem; }
.status-livre { background: #dcfce7; color: #166534; }
.status-ocupada { background: #fee2e2; color: #991b1b; }
.status-manutencao { background: #fef3c7; color: #92400e; }
.status-higienizacao { background: #dbeafe; color: #1e40af; }
.status-aguardando_qualidade { background: #fef3c7; color: #92400e; }
</style>
{% endblock %}
{% block content %}
<div class="dashboard-header">
    <h1 class="dashboard-title">üè≠ Dashboard de Monitoramento</h1>
    <p class="dashboard-subtitle">Vis√£o Geral em Tempo Real</p>
</div>
<div class="stats-grid">
    <div class="stat-card livre"><div class="stat-icon">‚úÖ</div><div class="stat-value">{{ equipamentos | selectattr('status', 'equalto', 'livre') | list | length }}</div><div class="stat-label">Dispon√≠veis</div></div>
    <div class="stat-card ocupada"><div class="stat-icon pulse">üî¥</div><div class="stat-value">{{ equipamentos | selectattr('status', 'equalto', 'ocupada') | list | length }}</div><div class="stat-label">Em Processo</div></div>
    <div class="stat-card manutencao"><div class="stat-icon">üîß</div><div class="stat-value">{{ equipamentos | selectattr('status', 'equalto', 'manutencao') | list | length }}</div><div class="stat-label">Em Manuten√ß√£o</div></div>
    <div class="stat-card higienizacao"><div class="stat-icon">üßº</div><div class="stat-value">{{ equipamentos | selectattr('status', 'equalto', 'higienizacao') | list | length }}</div><div class="stat-label">Em Higieniza√ß√£o</div></div>
</div>
<div class="card">
    <h2 class="card-title">Equipamentos</h2>
    <div class="equipamentos-grid">
        {% for equip in equipamentos %}
        <div class="equip-card {{ equip.status }}">
            <div class="equip-icon">{{ equip.icone }}</div>
            <h3 class="equip-name">{{ equip.nome }}</h3>
            <div style="text-align: center; margin-bottom: 1rem;">
                <span class="status-badge status-{{ equip.status }}">
                    {% if equip.status == 'livre' %}‚úÖ Dispon√≠vel
                    {% elif equip.status == 'ocupada' %}üî¥ Em Processo
                    {% elif equip.status == 'manutencao' %}üîß Manuten√ß√£o
                    {% elif equip.status == 'higienizacao' %}üßº Higieniza√ß√£o
                    {% elif equip.status == 'aguardando_qualidade' %}‚è≥ Aguardando
                    {% endif %}
                </span>
            </div>
            {% if equip.processo %}
            <div style="background: #f8fafc; padding: 1rem; border-radius: 8px; font-size: 0.9rem;">
                <p><strong>Produto:</strong> {{ equip.processo.produto }}</p>
                <p><strong>OP:</strong> {{ equip.processo.ordem_producao }}</p>
            </div>
            {% endif %}
            {% if equip.sensor_id %}
            <div id="temp-{{ equip.id }}" style="background: #e0f2fe; padding: 1rem; border-radius: 8px; margin-top: 1rem; text-align: center;">
                <div style="font-size: 2.5rem; font-weight: bold; color: var(--info);" id="temp-value-{{ equip.id }}">
                    <span class="loading">‚è≥</span>
                </div>
                <div style="font-size: 0.85rem; color: #0369a1; margin-top: 0.5rem;">
                    üå°Ô∏è Temperatura Atual
                </div>
                <div id="temp-alert-{{ equip.id }}" style="display: none; background: #fee2e2; color: #991b1b; padding: 0.5rem; border-radius: 6px; margin-top: 0.5rem; font-size: 0.85rem;">
                    ‚ö†Ô∏è Fora dos limites!
                </div>
            </div>
            {% endif %}
        </div>
        {% endfor %}
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Fun√ß√£o para buscar e atualizar temperatura
async function atualizarTemperatura(equipId) {
    try {
        const response = await fetch(`/api/equipamento/${equipId}/temperatura`);
        const data = await response.json();
        
        if (data.temperatura) {
            const tempElement = document.getElementById(`temp-value-${equipId}`);
            const alertElement = document.getElementById(`temp-alert-${equipId}`);
            
            // Atualizar temperatura
            tempElement.innerHTML = `${data.temperatura}¬∞C`;
            
            // Verificar alerta
            if (data.alerta) {
                alertElement.style.display = 'block';
                tempElement.style.color = 'var(--danger)';
            } else {
                alertElement.style.display = 'none';
                tempElement.style.color = 'var(--info)';
            }
        }
    } catch (error) {
        console.error(`Erro ao buscar temperatura do equipamento ${equipId}:`, error);
    }
}

// Atualizar temperaturas de todos os equipamentos com sensores
function atualizarTodasTemperaturas() {
    {% for equip in equipamentos %}
    {% if equip.sensor_id %}
    atualizarTemperatura({{ equip.id }});
    {% endif %}
    {% endfor %}
}

// Atualizar ao carregar e a cada 3 segundos
document.addEventListener('DOMContentLoaded', function() {
    atualizarTodasTemperaturas();
    setInterval(atualizarTodasTemperaturas, 3000);
});
</script>
{% endblock %}