{% extends "base.html" %}
{% block title %}Configura√ß√£o de Relat√≥rios{% endblock %}
{% block content %}
<div class="page-header" style="background: white; padding: 2rem; border-radius: 12px; margin-bottom: 2rem;">
    <h1 style="font-size: 2rem; color: var(--primary); margin-bottom: 0.5rem;">üìä Configura√ß√£o de Relat√≥rios</h1>
    <p style="color: #64748b;"><a href="{{ url_for('ti') }}" style="color: var(--primary);">‚Üê Voltar</a> | <a href="{{ url_for('gerenciar_layouts') }}" style="color: var(--info);">‚öôÔ∏è Gerenciar Layouts</a></p>
</div>
<div style="margin-bottom: 2rem;"><button onclick="openAddRelatorioModal()" class="btn btn-success">‚ûï Criar Novo Relat√≥rio</button></div>
<div class="card">
    <h2 class="card-title">Relat√≥rios Configurados</h2>
    <table style="width: 100%; border-collapse: collapse;">
        <thead style="background: var(--primary); color: white;">
            <tr>
                <th style="padding: 1rem; text-align: left;">Nome</th>
                <th style="padding: 1rem; text-align: left;">Tipo</th>
                <th style="padding: 1rem; text-align: left;">Formatos</th>
                <th style="padding: 1rem; text-align: left;">Status</th>
                <th style="padding: 1rem; text-align: left;">A√ß√µes</th>
            </tr>
        </thead>
        <tbody>
            {% for id_rel, rel in relatorios.items() %}
            <tr style="border-bottom: 1px solid #e2e8f0;">
                <td style="padding: 1rem;"><strong>{{ rel.nome }}</strong><br><small style="color: #64748b;">{{ rel.descricao }}</small></td>
                <td style="padding: 1rem;"><span class="badge badge-info">{{ rel.tipo | capitalize }}</span></td>
                <td style="padding: 1rem;">{% for formato in rel.formatos %}<span class="badge badge-secondary">{{ formato }}</span> {% endfor %}</td>
                <td style="padding: 1rem;">{% if rel.ativo %}<span class="badge badge-success">‚úÖ Ativo</span>{% else %}<span class="badge badge-secondary">‚ùå Inativo</span>{% endif %}</td>
                <td style="padding: 1rem;">
                    <div style="display: flex; gap: 0.5rem;">
                        <button onclick="editRelatorio('{{ id_rel }}')" class="btn btn-primary" style="padding: 0.5rem 0.75rem;">‚úèÔ∏è</button>
                        <form method="POST" style="display: inline;"><input type="hidden" name="acao" value="ativar_desativar"><input type="hidden" name="id_relatorio" value="{{ id_rel }}"><button type="submit" class="btn btn-warning" style="padding: 0.5rem 0.75rem;">{% if rel.ativo %}üîí{% else %}üîì{% endif %}</button></form>
                        <form method="POST" style="display: inline;"><input type="hidden" name="acao" value="excluir"><input type="hidden" name="id_relatorio" value="{{ id_rel }}"><button type="submit" class="btn btn-danger" style="padding: 0.5rem 0.75rem;" onclick="return confirm('Confirma?')">üóëÔ∏è</button></form>
                    </div>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
<div id="relatorioModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center; overflow-y: auto;">
    <div style="background: white; padding: 2rem; border-radius: 12px; max-width: 900px; width: 95%; margin: 2rem auto; max-height: 90vh; overflow-y: auto;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
            <h2 id="relatorioModalTitle" style="font-size: 1.5rem; color: var(--primary); margin: 0;">‚ûï Criar Relat√≥rio</h2>
            <span onclick="closeRelatorioModal()" style="font-size: 2rem; cursor: pointer; color: #94a3b8;">&times;</span>
        </div>
        <form method="POST">
            <input type="hidden" name="acao" id="relAcao" value="adicionar">
            <input type="hidden" name="id_relatorio" id="relId">
            <div class="form-group"><label class="form-label">ID *</label><input type="text" name="id_relatorio" id="relIdInput" class="form-control" required></div>
            <div class="form-group"><label class="form-label">Nome *</label><input type="text" name="nome" id="relNome" class="form-control" required></div>
            <div class="form-group"><label class="form-label">Descri√ß√£o</label><textarea name="descricao" id="relDescricao" class="form-control" rows="2"></textarea></div>
            <div class="form-group"><label class="form-label">Tipo *</label><select name="tipo" id="relTipo" class="form-control" required><option value="">Selecione...</option><option value="processos">Processos</option><option value="equipamentos">Equipamentos</option></select></div>
            <div style="background: #f8fafc; padding: 1rem; border-radius: 8px; margin: 1rem 0;"><label class="form-label">üìã Campos *</label>
            <div style="max-height: 300px; overflow-y: auto; background: white; padding: 1rem; border-radius: 8px;">
                <label style="display: flex; align-items: center; gap: 0.5rem; margin: 0.5rem 0;"><input type="checkbox" name="campos" value="equipamento">Equipamento</label>
                <label style="display: flex; align-items: center; gap: 0.5rem; margin: 0.5rem 0;"><input type="checkbox" name="campos" value="produto">Produto</label>
                <label style="display: flex; align-items: center; gap: 0.5rem; margin: 0.5rem 0;"><input type="checkbox" name="campos" value="ordem_producao">Ordem Produ√ß√£o</label>
                <label style="display: flex; align-items: center; gap: 0.5rem; margin: 0.5rem 0;"><input type="checkbox" name="campos" value="responsavel">Respons√°vel</label>
                <label style="display: flex; align-items: center; gap: 0.5rem; margin: 0.5rem 0;"><input type="checkbox" name="campos" value="data_finalizacao">Data Finaliza√ß√£o</label>
                <label style="display: flex; align-items: center; gap: 0.5rem; margin: 0.5rem 0;"><input type="checkbox" name="campos" value="status_qualidade">Status Qualidade</label>
            </div></div>
            <div style="background: #f8fafc; padding: 1rem; border-radius: 8px; margin: 1rem 0;"><label class="form-label">Formatos *</label>
                <label style="display: flex; align-items: center; gap: 0.5rem;"><input type="checkbox" name="formatos" value="excel">üìä Excel</label>
                <label style="display: flex; align-items: center; gap: 0.5rem;"><input type="checkbox" name="formatos" value="pdf">üìï PDF</label>
            </div>
            <div style="background: #f8fafc; padding: 1rem; border-radius: 8px; margin: 1rem 0;"><label class="form-label">Layouts</label>
                <div class="form-group"><label>Layout Excel</label><select name="layout_excel" id="relLayoutExcel" class="form-control"><option value="">Nenhum</option>{% for id, layout in layouts.items() %}{% if layout.tipo == 'excel' %}<option value="{{ id }}">{{ layout.nome }}</option>{% endif %}{% endfor %}</select></div>
                <div class="form-group"><label>Layout PDF</label><select name="layout_pdf" id="relLayoutPdf" class="form-control"><option value="">Nenhum</option>{% for id, layout in layouts.items() %}{% if layout.tipo == 'pdf' %}<option value="{{ id }}">{{ layout.nome }}</option>{% endif %}{% endfor %}</select></div>
            </div>
            <div style="display: flex; gap: 1rem; justify-content: flex-end;">
                <button type="button" onclick="closeRelatorioModal()" class="btn btn-secondary">‚ùå Cancelar</button>
                <button type="submit" class="btn btn-success">‚úÖ Criar</button>
            </div>
        </form>
    </div>
</div>
<script>
const relatoriosData = {{ relatorios | tojson | safe }};
function openAddRelatorioModal() {
    document.getElementById('relatorioModalTitle').textContent = '‚ûï Criar Relat√≥rio';
    document.getElementById('relAcao').value = 'adicionar';
    document.getElementById('relIdInput').readOnly = false;
    document.getElementById('relIdInput').value = '';
    document.getElementById('relNome').value = '';
    document.getElementById('relDescricao').value = '';
    document.getElementById('relTipo').value = '';
    document.querySelectorAll('input[name="campos"]').forEach(cb => cb.checked = false);
    document.querySelectorAll('input[name="formatos"]').forEach(cb => cb.checked = false);
    document.getElementById('relatorioModal').style.display = 'flex';
}
function editRelatorio(idRel) {
    const rel = relatoriosData[idRel];
    document.getElementById('relatorioModalTitle').textContent = '‚úèÔ∏è Editar Relat√≥rio';
    document.getElementById('relAcao').value = 'editar';
    document.getElementById('relIdInput').value = idRel;
    document.getElementById('relIdInput').readOnly = true;
    document.getElementById('relNome').value = rel.nome;
    document.getElementById('relDescricao').value = rel.descricao;
    document.getElementById('relTipo').value = rel.tipo;
    document.getElementById('relLayoutExcel').value = rel.layout_excel || '';
    document.getElementById('relLayoutPdf').value = rel.layout_pdf || '';
    document.querySelectorAll('input[name="campos"]').forEach(cb => cb.checked = rel.campos.includes(cb.value));
    document.querySelectorAll('input[name="formatos"]').forEach(cb => cb.checked = rel.formatos.includes(cb.value));
    document.getElementById('relatorioModal').style.display = 'flex';
}
function closeRelatorioModal() { document.getElementById('relatorioModal').style.display = 'none'; }
window.onclick = function(event) { if (event.target.id === 'relatorioModal') closeRelatorioModal(); }
</script>
{% endblock %}