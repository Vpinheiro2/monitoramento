{% extends "base.html" %}
{% block title %}Configura√ß√£o de Relat√≥rios{% endblock %}
{% block content %}
<div class="page-header" style="background: white; padding: 2rem; border-radius: 12px; margin-bottom: 2rem;">
    <h1 style="font-size: 2rem; color: var(--primary); margin-bottom: 0.5rem;">üìä Configura√ß√£o de Relat√≥rios</h1>
    <p style="color: #64748b;"><a href="{{ url_for('ti') }}" style="color: var(--primary);">‚Üê Voltar</a> | <a href="{{ url_for('gerenciar_layouts') }}" style="color: var(--info);">‚öôÔ∏è Gerenciar Layouts</a></p>
</div>
<div style="margin-bottom: 2rem;"><button onclick="openAddRelatorioModal()" class="btn btn-success">‚ûï Criar Novo Relat√≥rio</button></div>
<div class="card">
    <h2 class="card-title">Relat√≥rios Configurados</h2>
    <table style="width: 100%; border-collapse: collapse;">
        <thead style="background: var(--primary); color: white;">
            <tr>
                <th style="padding: 1rem; text-align: left;">Nome</th>
                <th style="padding: 1rem; text-align: left;">Tipo</th>
                <th style="padding: 1rem; text-align: left;">Campos</th>
                <th style="padding: 1rem; text-align: left;">Formatos</th>
                <th style="padding: 1rem; text-align: left;">Status</th>
                <th style="padding: 1rem; text-align: left;">A√ß√µes</th>
            </tr>
        </thead>
        <tbody>
            {% for id_rel, rel in relatorios.items() %}
            <tr style="border-bottom: 1px solid #e2e8f0;">
                <td style="padding: 1rem;"><strong>{{ rel.nome }}</strong><br><small style="color: #64748b;">{{ rel.descricao }}</small></td>
                <td style="padding: 1rem;"><span class="badge badge-info">{% if rel.tipo == 'outro' and rel.tipo_outro %}{{ rel.tipo_outro }}{% else %}{{ rel.tipo | capitalize }}{% endif %}</span></td>
                <td style="padding: 1rem;"><small style="color: #64748b;">{{ rel.campos | length }} campos</small></td>
                <td style="padding: 1rem;">{% for formato in rel.formatos %}<span class="badge badge-secondary">{{ formato }}</span> {% endfor %}</td>
                <td style="padding: 1rem;">{% if rel.ativo %}<span class="badge badge-success">‚úÖ Ativo</span>{% else %}<span class="badge badge-secondary">‚ùå Inativo</span>{% endif %}</td>
                <td style="padding: 1rem;">
                    <div style="display: flex; gap: 0.5rem;">
                        <button onclick="editRelatorio('{{ id_rel }}')" class="btn btn-primary" style="padding: 0.5rem 0.75rem;">‚úèÔ∏è</button>
                        <form method="POST" style="display: inline;"><input type="hidden" name="acao" value="ativar_desativar"><input type="hidden" name="id_relatorio" value="{{ id_rel }}"><button type="submit" class="btn btn-warning" style="padding: 0.5rem 0.75rem;">{% if rel.ativo %}üîí{% else %}üîì{% endif %}</button></form>
                        <form method="POST" style="display: inline;"><input type="hidden" name="acao" value="excluir"><input type="hidden" name="id_relatorio" value="{{ id_rel }}"><button type="submit" class="btn btn-danger" style="padding: 0.5rem 0.75rem;" onclick="return confirm('Confirma?')">üóëÔ∏è</button></form>
                    </div>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<!-- MODAL COM PREVIEW -->
<div id="relatorioModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 1000; overflow-y: auto;">
    <div style="background: white; max-width: 1400px; width: 95%; margin: 2rem auto; border-radius: 12px; display: flex; flex-direction: column; max-height: 90vh;">
        <div style="display: flex; justify-content: space-between; align-items: center; padding: 1.5rem; border-bottom: 2px solid #e2e8f0;">
            <h2 id="relatorioModalTitle" style="font-size: 1.5rem; color: var(--primary); margin: 0;">‚ûï Criar Relat√≥rio</h2>
            <span onclick="closeRelatorioModal()" style="font-size: 2rem; cursor: pointer; color: #94a3b8;">&times;</span>
        </div>
        
        <form method="POST" style="flex: 1; overflow-y: auto; display: flex;">
            <input type="hidden" name="acao" id="relAcao" value="adicionar">
            
            <!-- SIDEBAR -->
            <div style="width: 400px; padding: 1.5rem; border-right: 2px solid #e2e8f0; overflow-y: auto;">
                <div class="form-group"><label class="form-label">ID *</label><input type="text" name="id_relatorio" id="relIdInput" class="form-control" required></div>
                <div class="form-group"><label class="form-label">Nome *</label><input type="text" name="nome" id="relNome" class="form-control" required></div>
                <div class="form-group"><label class="form-label">Descri√ß√£o</label><textarea name="descricao" id="relDescricao" class="form-control" rows="2"></textarea></div>
                <div class="form-group"><label class="form-label">Tipo *</label><select name="tipo" id="relTipo" class="form-control" required onchange="updateCampos()"><option value="">Selecione...</option><option value="processos">Processos</option><option value="equipamentos">Equipamentos</option><option value="manutencao">Manuten√ß√£o</option><option value="higienizacao">Higieniza√ß√£o</option><option value="qualidade">Qualidade</option><option value="operador">Operador</option><option value="outro">Outro</option></select></div>
                <div id="tipoOutroDiv" style="display: none;" class="form-group"><label class="form-label">Especifique</label><input type="text" name="tipo_outro" id="relTipoOutro" class="form-control"></div>
                
                <div style="background: #f8fafc; padding: 1rem; border-radius: 8px; margin: 1rem 0;">
                    <label class="form-label">üìã Campos *</label>
                    <div id="camposContainer" style="max-height: 300px; overflow-y: auto;"></div>
                </div>
                
                <div style="background: #f8fafc; padding: 1rem; border-radius: 8px;">
                    <label class="form-label">Formatos *</label>
                    <label style="display: flex; align-items: center; gap: 0.5rem;"><input type="checkbox" name="formatos" value="excel">üìä Excel</label>
                    <label style="display: flex; align-items: center; gap: 0.5rem;"><input type="checkbox" name="formatos" value="pdf">üìï PDF</label>
                </div>
            </div>
            
            <!-- PREVIEW -->
            <div style="flex: 1; padding: 1.5rem; overflow-y: auto;">
                <h3 style="color: var(--primary); margin-bottom: 1rem;">üëÅÔ∏è Preview do Relat√≥rio</h3>
                <div id="previewContainer" style="background: white; border: 2px solid #e2e8f0; border-radius: 8px; padding: 1rem; min-height: 400px;">
                    <p style="color: #64748b; text-align: center; padding: 3rem;">Selecione campos para ver o preview</p>
                </div>
            </div>
        </form>
        
        <div style="display: flex; gap: 1rem; justify-content: flex-end; padding: 1.5rem; border-top: 2px solid #e2e8f0;">
            <button type="button" onclick="closeRelatorioModal()" class="btn btn-secondary">‚ùå Cancelar</button>
            <button type="button" onclick="document.querySelector('form').submit()" class="btn btn-success">‚úÖ Salvar</button>
        </div>
    </div>
</div>

<script>
const relatoriosData = {{ relatorios | tojson | safe }};

const camposPorTipo = {
    'processos': [
        {id: 'equipamento', nome: 'Equipamento'},
        {id: 'produto', nome: 'Produto'},
        {id: 'ordem_producao', nome: 'Ordem Produ√ß√£o'},
        {id: 'responsavel', nome: 'Respons√°vel'},
        {id: 'data_inicio', nome: 'Data In√≠cio'},
        {id: 'data_finalizacao', nome: 'Data Finaliza√ß√£o'},
        {id: 'duracao', nome: 'Dura√ß√£o'},
        {id: 'status_qualidade', nome: 'Status Qualidade'},
        {id: 'observacoes', nome: 'Observa√ß√µes'}
    ],
    'manutencao': [
        {id: 'equipamento', nome: 'Equipamento'},
        {id: 'tipo_manutencao', nome: 'Tipo Manuten√ß√£o'},
        {id: 'motivo', nome: 'Motivo'},
        {id: 'responsavel', nome: 'Respons√°vel'},
        {id: 'data_inicio', nome: 'Data In√≠cio'},
        {id: 'previsao_termino', nome: 'Previs√£o T√©rmino'},
        {id: 'pecas_utilizadas', nome: 'Pe√ßas Utilizadas'},
        {id: 'custo_estimado', nome: 'Custo Estimado'},
        {id: 'tempo_parada', nome: 'Tempo Parada'},
        {id: 'status', nome: 'Status'}
    ],
    'higienizacao': [
        {id: 'equipamento', nome: 'Equipamento'},
        {id: 'tipo_higienizacao', nome: 'Tipo Higieniza√ß√£o'},
        {id: 'responsavel', nome: 'Respons√°vel'},
        {id: 'data_inicio', nome: 'Data In√≠cio'},
        {id: 'data_termino', nome: 'Data T√©rmino'},
        {id: 'produtos_utilizados', nome: 'Produtos Utilizados'},
        {id: 'tempo_duracao', nome: 'Tempo Dura√ß√£o'},
        {id: 'responsavel_qualidade', nome: 'Resp. Qualidade'},
        {id: 'status_qualidade', nome: 'Status Qualidade'}
    ],
    'qualidade': [
        {id: 'equipamento', nome: 'Equipamento'},
        {id: 'produto', nome: 'Produto'},
        {id: 'ordem_producao', nome: 'Ordem Produ√ß√£o'},
        {id: 'analista', nome: 'Analista'},
        {id: 'data_analise', nome: 'Data An√°lise'},
        {id: 'resultado_analise', nome: 'Resultado'},
        {id: 'criterios_avaliados', nome: 'Crit√©rios Avaliados'},
        {id: 'observacoes', nome: 'Observa√ß√µes'},
        {id: 'acao_corretiva', nome: 'A√ß√£o Corretiva'}
    ],
    'operador': [
        {id: 'operador', nome: 'Operador'},
        {id: 'turno', nome: 'Turno'},
        {id: 'equipe', nome: 'Equipe'},
        {id: 'equipamento', nome: 'Equipamento'},
        {id: 'produto', nome: 'Produto'},
        {id: 'producao_planejada', nome: 'Produ√ß√£o Planejada'},
        {id: 'producao_real', nome: 'Produ√ß√£o Real'},
        {id: 'eficiencia', nome: 'Efici√™ncia %'},
        {id: 'paradas', nome: 'Paradas'},
        {id: 'observacoes', nome: 'Observa√ß√µes'}
    ],
    'equipamentos': [
        {id: 'equipamento', nome: 'Equipamento'},
        {id: 'tipo', nome: 'Tipo'},
        {id: 'localizacao', nome: 'Localiza√ß√£o'},
        {id: 'status', nome: 'Status'},
        {id: 'ultima_manutencao', nome: '√öltima Manuten√ß√£o'},
        {id: 'proxima_manutencao', nome: 'Pr√≥xima Manuten√ß√£o'},
        {id: 'tempo_operacao', nome: 'Tempo Opera√ß√£o'},
        {id: 'disponibilidade', nome: 'Disponibilidade %'}
    ]
};

function updateCampos() {
    const tipo = document.getElementById('relTipo').value;
    const container = document.getElementById('camposContainer');
    const tipoOutroDiv = document.getElementById('tipoOutroDiv');
    
    tipoOutroDiv.style.display = tipo === 'outro' ? 'block' : 'none';
    
    if (!tipo || tipo === 'outro') {
        container.innerHTML = '<p style="color: #64748b;">Selecione um tipo</p>';
        return;
    }
    
    const campos = camposPorTipo[tipo] || [];
    container.innerHTML = '';
    
    campos.forEach(campo => {
        const label = document.createElement('label');
        label.style.cssText = 'display: flex; align-items: center; gap: 0.5rem; margin: 0.5rem 0; cursor: pointer;';
        label.innerHTML = `<input type="checkbox" name="campos" value="${campo.id}" onchange="updatePreview()">${campo.nome}`;
        container.appendChild(label);
    });
    
    updatePreview();
}

function updatePreview() {
    const tipo = document.getElementById('relTipo').value;
    const checkboxes = document.querySelectorAll('input[name="campos"]:checked');
    const preview = document.getElementById('previewContainer');
    
    if (checkboxes.length === 0) {
        preview.innerHTML = '<p style="color: #64748b; text-align: center; padding: 3rem;">Selecione campos para ver o preview</p>';
        return;
    }
    
    let html = '<table style="width: 100%; border-collapse: collapse; border: 1px solid #e2e8f0;">';
    html += '<thead style="background: var(--primary); color: white;"><tr>';
    
    checkboxes.forEach(cb => {
        const campo = camposPorTipo[tipo]?.find(c => c.id === cb.value);
        if (campo) html += `<th style="padding: 0.75rem; text-align: left; border: 1px solid #e2e8f0;">${campo.nome}</th>`;
    });
    
    html += '</tr></thead><tbody>';
    
    for (let i = 0; i < 3; i++) {
        html += `<tr style="background: ${i % 2 === 0 ? '#ffffff' : '#f8fafc'};">`;
        checkboxes.forEach(() => {
            html += '<td style="padding: 0.5rem; border: 1px solid #e2e8f0;">Exemplo</td>';
        });
        html += '</tr>';
    }
    
    html += '</tbody></table>';
    preview.innerHTML = html;
}

function openAddRelatorioModal() {
    document.getElementById('relatorioModalTitle').textContent = '‚ûï Criar Relat√≥rio';
    document.getElementById('relAcao').value = 'adicionar';
    document.getElementById('relIdInput').readOnly = false;
    document.querySelector('form').reset();
    document.getElementById('camposContainer').innerHTML = '';
    document.getElementById('previewContainer').innerHTML = '<p style="color: #64748b; text-align: center; padding: 3rem;">Selecione campos para ver o preview</p>';
    document.getElementById('relatorioModal').style.display = 'block';
}

function editRelatorio(idRel) {
    const rel = relatoriosData[idRel];
    document.getElementById('relatorioModalTitle').textContent = '‚úèÔ∏è Editar Relat√≥rio';
    document.getElementById('relAcao').value = 'editar';
    document.getElementById('relIdInput').value = idRel;
    document.getElementById('relIdInput').readOnly = true;
    document.getElementById('relNome').value = rel.nome;
    document.getElementById('relDescricao').value = rel.descricao || '';
    document.getElementById('relTipo').value = rel.tipo;
    if (rel.tipo === 'outro') document.getElementById('relTipoOutro').value = rel.tipo_outro || '';
    updateCampos();
    setTimeout(() => {
        rel.campos.forEach(campoId => {
            const checkbox = document.querySelector(`input[name="campos"][value="${campoId}"]`);
            if (checkbox) checkbox.checked = true;
        });
        rel.formatos.forEach(formato => {
            const checkbox = document.querySelector(`input[name="formatos"][value="${formato}"]`);
            if (checkbox) checkbox.checked = true;
        });
        updatePreview();
    }, 100);
    document.getElementById('relatorioModal').style.display = 'block';
}

function closeRelatorioModal() {
    document.getElementById('relatorioModal').style.display = 'none';
}

window.onclick = function(event) {
    if (event.target.id === 'relatorioModal') closeRelatorioModal();
}
</script>
{% endblock %}